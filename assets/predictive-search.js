class PredictiveSearch extends HTMLElement{constructor(){super(),this.modal=this.closest(".search-modal"),this.cachedResults={},this.input=this.querySelector('input[type="search"]'),this.predictiveSearchResults=this.querySelector("[data-predictive-search]"),this.allPredictiveSearchInstances=document.querySelectorAll("predictive-search"),this.isOpen=!1,this.searchTerm="",this.setupEventListeners()}setupEventListeners(){this.querySelector("form.search").addEventListener("submit",this.onFormSubmit.bind(this)),this.querySelector('button[type="button"]').addEventListener("click",this.close.bind(this)),this.querySelector('button[type="reset"]').addEventListener("click",this.clear.bind(this)),this.input.addEventListener("input",debounce((e=>{this.onChange(e)}),300).bind(this)),this.input.addEventListener("focus",this.onFocus.bind(this)),this.addEventListener("focusout",this.onFocusOut.bind(this)),this.addEventListener("keyup",this.onKeyup.bind(this)),this.addEventListener("keydown",this.onKeydown.bind(this))}getQuery(){return this.input.value.trim()}onChange(){const e=this.getQuery();if(this.searchTerm&&e.startsWith(this.searchTerm)||this.querySelector("#predictive-search-results-groups-wrapper")?.remove(),this.updateSearchForTerm(this.searchTerm,e),this.searchTerm=e,!this.searchTerm.length)return this.clear(),void this.close(!0);this.getSearchResults(this.searchTerm)}onFormSubmit(e){this.getQuery().length&&!this.querySelector('[aria-selected="true"] a')||e.preventDefault()}onFocus(){document.body.classList.add("predictive-search--focus");const e=this.getQuery();e.length&&(this.searchTerm!==e?this.onChange():"true"===this.getAttribute("results")?this.open():this.getSearchResults(this.searchTerm))}onFocusOut(){setTimeout((()=>{this.contains(document.activeElement)||this.close()}))}onKeyup(e){switch(this.getQuery().length||(this.clear(e),this.close(!0)),e.preventDefault(),e.code){case"ArrowUp":this.switchOption("up");break;case"ArrowDown":this.switchOption("down");break;case"Enter":this.selectOption()}}onKeydown(e){"ArrowUp"!==e.code&&"ArrowDown"!==e.code||e.preventDefault()}updateSearchForTerm(e,t){const s=this.querySelector("[data-predictive-search-search-for-text]"),i=s?.innerText;if(i){const r=i.replace(e,t);s.innerText=r}}switchOption(e){if(!this.getAttribute("open"))return;const t="up"===e,s=this.querySelector('[aria-selected="true"]'),i=this.querySelectorAll("li");let r=this.querySelector("li");t&&!s||(this.statusElement.textContent="",!t&&s?r=s.nextElementSibling||i[0]:t&&(r=s.previousElementSibling||i[i.length-1]),r!==s&&(r.setAttribute("aria-selected",!0),s&&s.setAttribute("aria-selected",!1),this.setLiveRegionText(r.textContent),this.input.setAttribute("aria-activedescendant",r.id)))}selectOption(){const e=this.querySelector('[aria-selected="true"] a, [aria-selected="true"] button');e&&e.click()}getSearchResults(e){const t=e.replace(" ","-").toLowerCase(),s=this.dataset.perPage||4;if(this.setLiveRegionLoadingState(),this.cachedResults[t])return this.renderSearchResults(this.cachedResults[t]),void(this.modal&&this.modal.classList.add("searching"));fetch(`${window.routes.predictive_search_url}?q=${encodeURIComponent(e)}&${encodeURIComponent("resources[limit]")}=${s}&section_id=predictive-search`).then((e=>{if(!e.ok){var t=new Error(e.status);throw this.close(),t}return e.text()})).then((e=>{const s=(new DOMParser).parseFromString(e,"text/html").querySelector("#shopify-section-predictive-search").innerHTML;this.allPredictiveSearchInstances.forEach((e=>{e.cachedResults[t]=s})),this.renderSearchResults(s),this.modal&&this.modal.classList.add("searching")})).catch((e=>{if(20!==e?.code)throw this.close(),e}))}setLiveRegionLoadingState(){this.statusElement=this.statusElement||this.querySelector(".predictive-search-status"),this.loadingText=this.loadingText||this.getAttribute("data-loading-text"),this.setLiveRegionText(this.loadingText),this.setAttribute("loading",!0)}setLiveRegionText(e){this.statusElement.setAttribute("aria-hidden","false"),this.statusElement.textContent=e,setTimeout((()=>{this.statusElement.setAttribute("aria-hidden","true")}),1e3)}renderSearchResults(e){this.predictiveSearchResults.innerHTML=e,this.setAttribute("results",!0),this.setLiveRegionResults(),this.open()}setLiveRegionResults(){this.removeAttribute("loading"),this.setLiveRegionText(this.querySelector("[data-predictive-search-live-region-count-value]").textContent)}getResultsMaxHeight(){return this.resultsMaxHeight=window.innerHeight-document.querySelector(".header").getBoundingClientRect().bottom,this.resultsMaxHeight}open(){this.predictiveSearchResults.style.maxHeight=this.resultsMaxHeight||`${this.getResultsMaxHeight()}px`,this.setAttribute("open",!0),this.input.setAttribute("aria-expanded",!0),this.isOpen=!0,document.body.classList.add("predictive-search--focus")}close(e=!1){this.closeResults(e),this.isOpen=!1}closeResults(e=!1){e&&(this.input.value="",this.removeAttribute("results"));const t=this.querySelector('[aria-selected="true"]');t&&t.setAttribute("aria-selected",!1),this.input.setAttribute("aria-activedescendant",""),this.removeAttribute("loading"),this.removeAttribute("open"),this.input.setAttribute("aria-expanded",!1),document.body.classList.remove("predictive-search--focus")}clear(e){e.preventDefault(),this.input.value="",this.removeAttribute("open"),this.removeAttribute("results"),this.input.focus(),this.modal&&this.modal.classList.remove("searching")}}customElements.define("predictive-search",PredictiveSearch);